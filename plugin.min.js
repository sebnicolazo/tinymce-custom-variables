!function(){var plugin;(function(){"use strict";var setup=function(editor,url){var mapper=editor.getParam("variable_mapper",{}),valid=editor.getParam("variable_valid",null),className=editor.getParam("variable_class","tinymce-variable"),prefix=editor.getParam("variable_prefix","{{"),suffix=editor.getParam("variable_suffix","}}"),stringVariableRegex=new RegExp(prefix+"([a-z. _]*)?"+suffix,"g");function isValid(name){return!valid||0===valid.length||("|"+valid.join("|")+"|").indexOf("|"+name+"|")>-1;var validString}function getMappedValue(cleanValue){return"function"==typeof mapper?mapper(cleanValue):mapper.hasOwnProperty(cleanValue)?mapper[cleanValue]:cleanValue}function cleanVariable(value){return value.replace(/[^a-zA-Z._]/g,"")}function createHTMLVariable(value){var cleanValue=cleanVariable(value);if(!isValid(cleanValue))return cleanValue;var cleanMappedValue=getMappedValue(cleanValue),variable;return editor.fire("variableToHTML",{value:value,cleanValue:cleanValue}),'<span class="'+className+'" data-original-variable="'+(prefix+cleanValue+suffix)+'" contenteditable="false">'+cleanMappedValue+"</span>"}function stringToHTML(){var nodeList=[],nodeValue,node,div;tinymce.walk(editor.getBody(),function(n){if(3==n.nodeType&&n.nodeValue&&stringVariableRegex.test(n.nodeValue)){for(nodeValue=n.nodeValue.replace(stringVariableRegex,createHTMLVariable),div=editor.dom.create("div",null,nodeValue);node=div.lastChild;)if(editor.dom.insertAfter(node,n),isVariable(node)){var next=node.nextSibling;editor.selection.setCursorLocation(next)}editor.dom.remove(n)}},"childNodes")}function htmlToString(){var nodeList=[],nodeValue,node,div;tinymce.walk(editor.getBody(),function(n){var original;1===n.nodeType&&(null!==n.getAttribute("data-original-variable")&&nodeList.push(n))},"childNodes");for(var _i=0,nodeList_2=nodeList;_i<nodeList_2.length;_i++){var nodeElement=nodeList_2[_i];for(nodeValue=nodeElement.getAttribute("data-original-variable"),div=editor.dom.create("div",null,nodeValue);null!=(node=div.lastChild);)editor.dom.insertAfter(node,nodeElement);editor.dom.remove(nodeElement)}}function addVariable(value){var htmlVariable=createHTMLVariable(value);editor.execCommand("mceInsertContent",!1,htmlVariable)}function isVariable(element){return!("function"!=typeof element.getAttribute||!element.hasAttribute("data-original-variable"))}function createMenuItems(){for(var menu=[],_loop_1=function(key){valid.indexOf(key)>-1&&menu.push({text:mapper[key],onclick:function(){addVariable(key)}})},_i=0,_a=Object.keys(mapper);_i<_a.length;_i++){var key;_loop_1(_a[_i])}return menu}this.htmlToString=htmlToString,this.stringToHTML=stringToHTML,editor.on("nodechange",stringToHTML),editor.on("keyup",stringToHTML),editor.addButton("variable",{type:"menubutton",text:"Variable",icon:!1,menu:createMenuItems()})};function Plugin(){}return tinymce.PluginManager.add("variable",setup),Plugin})()()}();